name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "agent-script/**"
      - "deploy-apps/**"
      - "dumpscript/**"
      - "k8s-monitoring-app/**"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout helm-charts repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: helm-charts

      - name: Checkout cloudscript-technology.github.io repository
        uses: actions/checkout@v4
        with:
          repository: cloudscript-technology/cloudscript-technology.github.io
          token: ${{ secrets.GITHUB_TOKEN }}
          path: gh-pages-repo

      - name: Configure Git
        run: |
          git config --global user.name "$GITHUB_ACTOR"
          git config --global user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.14.0"

      - name: Detect changed charts
        id: detect-changes
        run: |
          cd helm-charts

          # Get the previous commit
          PREV_COMMIT=$(git rev-parse HEAD^)

          # Initialize arrays
          changed_charts=()

          # Check each chart for changes
          for chart_dir in agent-script deploy-apps dumpscript k8s-monitoring-app; do
            if [ -d "$chart_dir" ] && [ -f "$chart_dir/Chart.yaml" ]; then
              # Check if chart has changes
              if git diff --name-only $PREV_COMMIT HEAD | grep -q "^${chart_dir}/"; then
                echo "Chart $chart_dir has changes"

                # Get current version
                version=$(grep '^version:' "$chart_dir/Chart.yaml" | awk '{print $2}')

                # Check if this version already exists in the public repo
                if [ ! -f "../gh-pages-repo/helm-charts/${chart_dir}-${version}.tgz" ]; then
                  echo "  Version $version is new, will release"
                  changed_charts+=("$chart_dir")
                else
                  echo "  Version $version already exists, skipping"
                fi
              fi
            fi
          done

          # Export to output
          if [ ${#changed_charts[@]} -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new chart versions to release"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "charts=${changed_charts[*]}" >> $GITHUB_OUTPUT
            echo "Will release: ${changed_charts[*]}"
          fi

      - name: Package and publish charts
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          cd helm-charts

          # Create temp directory for packages
          mkdir -p /tmp/chart-packages

          # Package each changed chart
          for chart in ${{ steps.detect-changes.outputs.charts }}; do
            echo "=================================="
            echo "Processing chart: $chart"
            echo "=================================="

            # Lint the chart
            echo "Linting $chart..."
            helm lint "./$chart"

            # Package the chart
            echo "Packaging $chart..."
            helm package "./$chart" -d /tmp/chart-packages

            # Get chart metadata
            chart_version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
            chart_app_version=$(grep '^appVersion:' "$chart/Chart.yaml" | awk '{print $2}' | tr -d '"')

            # Copy package to public repo
            echo "Copying package to public repository..."
            mkdir -p ../gh-pages-repo/helm-charts
            cp /tmp/chart-packages/${chart}-${chart_version}.tgz ../gh-pages-repo/helm-charts/

            # Generate SHA256
            cd ../gh-pages-repo/helm-charts
            sha256=$(sha256sum "${chart}-${chart_version}.tgz" | awk '{print $1}')
            echo "SHA256: $sha256"

            # Copy README if exists
            if [ -f "../../helm-charts/$chart/README.md" ]; then
              echo "Copying README..."
              mkdir -p "$chart"
              cp "../../helm-charts/$chart/README.md" "$chart/"
            fi

            # Create/update artifacthub metadata
            echo "Creating Artifact Hub metadata..."
            cat > "${chart}-artifacthub.yml" << ARTIFACTHUB_METADATA
            version: ${chart_version}
            name: ${chart}
            displayName: $(grep '^name:' "../../helm-charts/$chart/Chart.yaml" | awk '{print $2}')
            createdAt: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            description: $(grep '^description:' "../../helm-charts/$chart/Chart.yaml" | cut -d':' -f2- | sed 's/^[[:space:]]*//' | sed 's/^"//' | sed 's/"$//')
            digest: ${sha256}
            license: Apache-2.0
            homeURL: https://cloudscript.com.br
            appVersion: ${chart_app_version}
            containsSecurityUpdates: false
            operator: false
            deprecated: false
            prerelease: false
            keywords:
            - kubernetes
            - helm
            - cloudscript
            maintainers:
            - name: Jonathan Schmitt
              email: jonathan.schmitt@cloudscript.com.br
            links:
            - name: Chart Repository
              url: https://github.com/cloudscript-technology/helm-charts
            - name: Cloudscript
              url: https://cloudscript.com.br
            ARTIFACTHUB_METADATA

            # Remove leading whitespace from the generated file
            sed -i 's/^[[:space:]]*//' "${chart}-artifacthub.yml" || sed -i '' 's/^[[:space:]]*//' "${chart}-artifacthub.yml"

            cd ../../helm-charts

            echo "âœ“ Chart $chart version $chart_version packaged successfully"
            echo ""
          done

      - name: Update repository index
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          cd gh-pages-repo/helm-charts

          echo "Updating Helm repository index..."
          helm repo index . --url https://cloudscript-technology.github.io/helm-charts

          echo "âœ“ Repository index updated"

      - name: Create GitHub releases
        if: steps.detect-changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd helm-charts

          for chart in ${{ steps.detect-changes.outputs.charts }}; do
            chart_version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
            chart_description=$(grep '^description:' "$chart/Chart.yaml" | cut -d':' -f2- | sed 's/^[[:space:]]*//' | sed 's/^"//' | sed 's/"$//')

            tag_name="${chart}-${chart_version}"

            # Check if release already exists
            if gh release view "$tag_name" >/dev/null 2>&1; then
              echo "Release $tag_name already exists, skipping"
              continue
            fi

            echo "Creating GitHub release: $tag_name"

            # Create release notes with direct variable expansion
            cat > /tmp/release-notes.md <<RELEASE_NOTES_END
            # ${chart} v${chart_version}

            ${chart_description}

            ## Installation

            \`\`\`bash
            helm repo add cloudscript https://cloudscript-technology.github.io/helm-charts
            helm repo update
            helm install my-release cloudscript/${chart}
            \`\`\`

            ## What's Changed

            \$(git log --pretty=format:"- %s" \$(git describe --tags --abbrev=0 ${chart}-* 2>/dev/null || echo "")..HEAD -- ${chart}/ 2>/dev/null || echo "Initial release")

            ---

            **Full Changelog**: https://github.com/cloudscript-technology/helm-charts/commits/${tag_name}
            RELEASE_NOTES_END

            # Create release with package attached
            gh release create "$tag_name" \
              --title "$chart v$chart_version" \
              --notes-file /tmp/release-notes.md \
              /tmp/chart-packages/${chart}-${chart_version}.tgz

            echo "âœ“ Release $tag_name created"
          done

      - name: Commit and push to public repository
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          cd gh-pages-repo

          # Check if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Release Helm charts: ${{ steps.detect-changes.outputs.charts }}

            Published charts:
            $(for chart in ${{ steps.detect-changes.outputs.charts }}; do
              version=$(grep '^version:' "../helm-charts/$chart/Chart.yaml" | awk '{print $2}')
              echo "- $chart v$version"
            done)

            Source: ${{ github.repository }}@${{ github.sha }}"

            git push

            echo "âœ“ Changes pushed to cloudscript-technology.github.io"
          else
            echo "No changes to commit"
          fi

      - name: Summary
        if: steps.detect-changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ Helm Charts Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following charts have been published to the public repository:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          cd helm-charts
          for chart in ${{ steps.detect-changes.outputs.charts }}; do
            version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
            echo "### ðŸ“¦ $chart v$version" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Install:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "helm repo add cloudscript https://cloudscript-technology.github.io/helm-charts" >> $GITHUB_STEP_SUMMARY
            echo "helm install my-release cloudscript/$chart --version $version" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://cloudscript-technology.github.io/helm-charts" >> $GITHUB_STEP_SUMMARY
          echo "**Index:** https://cloudscript-technology.github.io/helm-charts/index.yaml" >> $GITHUB_STEP_SUMMARY

      - name: No changes detected
        if: steps.detect-changes.outputs.has_changes == 'false'
        run: |
          echo "## â„¹ï¸ No New Chart Versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No charts were released because:" >> $GITHUB_STEP_SUMMARY
          echo "- No chart versions were incremented, or" >> $GITHUB_STEP_SUMMARY
          echo "- All changed chart versions already exist in the repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a release, increment the version in Chart.yaml using:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "make bump CHART=<chart-name> TYPE=patch" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
